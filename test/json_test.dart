import 'dart:convert';

import 'package:flutter_test/flutter_test.dart';
import 'package:hn_app/json_parsing.dart';
import 'package:http/http.dart' as http;
void main() {
  test("parses topstories.json", () {
    const jsonString =
        "[ 26422799, 26423002, 26424090, 26424785, 26423406, 26423090, 26425318, 26424855, 26423558, 26423072, 26424903, 26421963, 26423344, 26422109, 26423102, 26422011, 26425452, 26419628, 26420692, 26401008, 26419717, 26413263, 26425071, 26424965, 26424300, 26414132, 26424919, 26423977, 26419334, 26423110, 26420716, 26421148, 26420180, 26421117, 26401153, 26401342, 26412624, 26419782, 26400517, 26424168, 26423689, 26422923, 26425144, 26419176, 26421106, 26400218, 26422872, 26421454, 26423880, 26425082, 26399329, 26421345, 26424761, 26399375, 26416531, 26408580, 26419584, 26419070, 26424239, 26416553, 26420665, 26407323, 26413311, 26400521, 26400204, 26424538, 26423022, 26423923, 26422247, 26423000, 26410135, 26404675, 26399143, 26411096, 26422580, 26415856, 26413343, 26416545, 26420954, 26420669, 26418830, 26399071, 26415048, 26411908, 26423527, 26405962, 26408181, 26419879, 26404830, 26401158, 26405056, 26421922, 26400168, 26413955, 26417187, 26418307, 26420599, 26406989, 26416621, 26418872, 26418492, 26411188, 26414555, 26409820, 26399728, 26406977, 26423245, 26400256, 26411818, 26398960, 26417515, 26420924, 26424587, 26401334, 26423774, 26402682, 26417491, 26399684, 26396759, 26408822, 26415657, 26413937, 26416266, 26419657, 26418809, 26413503, 26400602, 26411686, 26422286, 26414741, 26401568, 26418406, 26403341, 26421436, 26415558, 26414963, 26411499, 26418955, 26414938, 26413276, 26415981, 26393824, 26401371, 26396798, 26398767, 26401955, 26403669, 26400053, 26393795, 26406981, 26410575, 26420228, 26422781, 26409174, 26410047, 26410643, 26418680, 26418191, 26409076, 26396594, 26413336, 26398518, 26420322, 26418121, 26389006, 26407783, 26412724, 26418133, 26421807, 26420377, 26398415, 26420864, 26422609, 26399377, 26407016, 26409156, 26407560, 26422494, 26408382, 26421418, 26401782, 26420981, 26413045, 26401081, 26419572, 26418550, 26418730, 26407854, 26400239, 26400587, 26405515, 26409916, 26408941, 26399672, 26409247, 26398798, 26406206, 26401935, 26390896, 26402780, 26416113, 26424186, 26395361, 26409020, 26414283, 26399758, 26399707, 26403505, 26396978, 26395898, 26394564, 26413290, 26419633, 26413948, 26401838, 26396142, 26420851, 26409419, 26412331, 26395138, 26399224, 26401140, 26418229, 26401786, 26393171, 26393381, 26418656, 26396671, 26406082, 26400017, 26403614, 26388414, 26419742, 26416402, 26390040, 26415396, 26392453, 26416104, 26409132, 26416337, 26413651, 26389025, 26404164, 26419354, 26391261, 26408620, 26400089, 26415153, 26419978, 26419158, 26408141, 26421206, 26401004, 26418965, 26411870, 26419700, 26414136, 26418573, 26414049, 26393944, 26408984, 26398197, 26400314, 26399733, 26403790, 26405919, 26417373, 26408041, 26397924, 26407080, 26408374, 26413885, 26400374, 26405955, 26418724, 26390835, 26414321, 26401431, 26398870, 26398129, 26392125, 26396323, 26407388, 26421939, 26397734, 26389397, 26404799, 26407973, 26406901, 26403606, 26408198, 26413984, 26406175, 26406157, 26419198, 26413128, 26416092, 26408521, 26407211, 26413536, 26388751, 26402707, 26414967, 26401611, 26397422, 26412254, 26412231, 26415354, 26404408, 26410303, 26397064, 26404248, 26418676, 26389657, 26407521, 26403480, 26395563, 26391254, 26416018, 26414706, 26415909, 26418382, 26396298, 26415703, 26423547, 26418042, 26420865, 26406583, 26414930, 26403857, 26421957, 26391600, 26417307, 26408762, 26417053, 26394624, 26402729, 26392892, 26412281, 26406864, 26406118, 26407562, 26416382, 26413384, 26400144, 26413261, 26404053, 26390101, 26405209, 26390752, 26396847, 26407010, 26390331, 26390545, 26389815, 26391584, 26401548, 26405421, 26410875, 26406283, 26397439, 26415123, 26397329, 26407017, 26404572, 26410027, 26399394, 26414769, 26417027, 26391927, 26414320, 26399239, 26399181, 26419077, 26395142, 26409387, 26407174, 26409331, 26413867, 26410644, 26405537, 26413602, 26393930, 26393706, 26397275, 26391500, 26408504, 26412546, 26395712, 26391787, 26412292, 26391269, 26408048, 26393182, 26411892, 26409497, 26390515, 26391756, 26405947, 26409427, 26400280, 26404069, 26401062, 26406103, 26396869, 26418209, 26408652, 26410622, 26402898, 26408271, 26413561, 26393431, 26393219, 26402605, 26402216, 26392284, 26392276, 26396175, 26391933, 26405022, 26390053, 26400534, 26407102, 26414048, 26411934, 26407055, 26409282, 26406755, 26408982, 26406673, 26388936, 26404380, 26403364, 26403260, 26408326, 26405158, 26396012, 26395629, 26404359, 26411626, 26403445, 26403203, 26407393, 26402917, 26415379, 26398255, 26408467, 26396041, 26396002, 26401537, 26395640, 26394824, 26406945, 26399978, 26394936, 26395032, 26394317, 26390741, 26390834, 26391624, 26405348, 26398713, 26405258, 26393200, 26393020, 26404627, 26395492, 26392066, 26411624, 26391446, 26401115, 26390529, 26390571, 26412653, 26410520, 26401451, 26393646, 26393643, 26394778, 26397819, 26401645, 26396311, 26396213, 26392674, 26395816, 26395697, 26401715, 26398102, 26390874, 26414293, 26410790, 26406909, 26394612, 26398277, 26405095, 26406969, 26393357, 26402966, 26392853, 26392728 ]";
    expect(parseTopStories(jsonString).first, 26422799);
  });


  test("parses topstories.json", () {
    const jsonString =
        """{"by":"tinyprojects","descendants":290,"id":26422799,"kids":[26423603,26423478,26423024,26423164,26424647,26423088,26423421,26422990,26425448,26423068,26425279,26423436,26423817,26423056,26423060,26425089,26423055,26423036,26424961,26424898,26425262,26423455,26423016,26423905,26424230,26423265,26425272,26423026,26424389,26423257,26425416,26424563,26423572,26423362,26424953,26423736,26424542,26424151,26423660,26423641,26423733,26423241,26423671,26423714,26422965,26424568,26423836,26423025,26423062,26423015,26423135,26423159,26423464,26423510,26423032,26423526,26423069],"score":677,"time":1615461428,"title":"I bought 300 emoji domain names from Kazakhstan and built an email service","type":"story","url":"https://tinyprojects.dev/projects/mailoji"}""";
    expect(parseArticle(jsonString).by, "tinyprojects");
  });

  test("parses item.json over a network", () async {
    final url = Uri.https('hacker-news.firebaseio.com','/v0/beststories.json');
    final response = await http.get(url);
    if(response.statusCode == 200){
      final idListJson = jsonDecode(response.body);
      if(idListJson.isNotEmpty){
        final storyUrl = Uri.https('hacker-news.firebaseio.com','/v0/${idListJson.first}.json');
        final storyRes = await http.get(storyUrl);
            if(response.statusCode == 200){
              expect(parseArticle(storyRes.body).by, "tinyprojects");
            }
      }
    }
  },);
}
